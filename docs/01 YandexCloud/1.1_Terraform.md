---
id: 1.1_Terraform
aliases: []
tags: []
---

# Terraform

## –ë–∞–∑–æ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è

–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Terraform:

    –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, –∏–ª–∏ Configuration Files
    –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã, –∏–ª–∏ Providers
    –†–µ—Å—É—Ä—Å—ã, –∏–ª–∏ Resources
    –ü—Ä–æ–≤–∏–∂–µ–Ω–µ—Ä—ã, –∏–ª–∏ Provisioners
    –°–æ—Å—Ç–æ—è–Ω–∏–µ, –∏–ª–∏ State

## –†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å

1Ô∏è‚É£ Write –∏–ª–∏ Init
2Ô∏è‚É£ Plan
3Ô∏è‚É£ Apply

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
–ö–æ–¥ –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è Managed Service for YDB:

=== ":octicons-file-code-16: `main.tf`"
    ```terraform
    # –°–æ–∑–¥–∞–Ω–∏–µ VPC –∏ –ø–æ–¥—Å–µ—Ç–∏
    resource "yandex_vpc_network" "this" {
      name = "private"
    }

    resource "yandex_vpc_subnet" "private" {
      name           = "private"
      zone           = "ru-central1-a"
      v4_cidr_blocks = ["192.168.10.0/24"]
      network_id     = yandex_vpc_network.this.id
    }

    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Å–∫–∞ –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
    resource "yandex_compute_disk" "boot_disk" {
      name     = "boot-disk"
      zone     = "ru-central1-a"
      image_id = "fd8ba9d5mfvlncknt2kd" # Ubuntu 22.04 LTS
      size     = 15
    }

    resource "yandex_compute_instance" "this" {
      name                      = "linux-vm"
      allow_stopping_for_update = true
      platform_id               = "standard-v3"
      zone                      = "ru-central1-a"

      resources {
        cores  = "2"
        memory = "4"
      }

      boot_disk {
        disk_id = yandex_compute_disk.boot_disk.id
      }

      network_interface {
        subnet_id = yandex_vpc_subnet.private.id
      }
    }

    # –°–æ–∑–¥–∞–Ω–∏–µ Yandex Managed Service for YDB
    resource "yandex_ydb_database_serverless" "this" {
      name        = "test-ydb-serverless"
      location_id = "ru-central1"
    }

    # –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ 
    resource "yandex_iam_service_account" "bucket" {
      name = "bucket-sa"
    }

    # –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ —Å–µ—Ä–≤–∏—Å–Ω–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É
    resource "yandex_resourcemanager_folder_iam_member" "storage_editor" {
      folder_id = "b1gt98o9j856o777k9r5"
      role      = "storage.editor"
      member    = "serviceAccount:${yandex_iam_service_account.bucket.id}"
    }

    # –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–ª—é—á–∞ –¥–æ—Å—Ç—É–ø–∞
    resource "yandex_iam_service_account_static_access_key" "this" {
      service_account_id = yandex_iam_service_account.bucket.id
      description        = "static access key for object storage"
    }

    # –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∫–µ—Ç–∞ 
    resource "yandex_storage_bucket" "this" {
      bucket     = "test-s3-bucket-fm3oijfiwf3oro23dffoi93"
      access_key = yandex_iam_service_account_static_access_key.this.access_key
      secret_key = yandex_iam_service_account_static_access_key.this.secret_key

      depends_on = [yandex_resourcemanager_folder_iam_member.storage_editor]
    }
    ```

=== ":octicons-file-code-16: `provider.tf`"
    ```terraform
    terraform {
      required_providers {
        yandex = {
          source = "yandex-cloud/yandex"
        }
      }
      required_version = ">= 1.00"
    }

    provider "yandex" {
      zone      = "ru-central1-a"
      folder_id = "b1gt98o9j856o777k9r5"
    }
    ```

–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞

```
terraform init
terraform plan
terraform apply

# –ó–∞–º–µ–Ω–∏—Ç—å –æ–±—Ä–∞–∑
terraform apply -replace yandex_compute_disk.boot_disk
```

–£–¥–∞–ª–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã

```
terraform destroy
```

## –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

```terraform
terraform {
  required_providers {
    random = {
      source = "hashicorp/random"
    }
  }
  required_version = ">= 0.13"
}

resource "random_string" "bucket_name" {
  length  = 8
  special = false
  upper   = false
} 

# –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∫–µ—Ç–∞ 
resource "yandex_storage_bucket" "this" {
  bucket     = "terraform-bucket-${random_string.bucket_name.result}"
  access_key = yandex_iam_service_account_static_access_key.this.access_key
  secret_key = yandex_iam_service_account_static_access_key.this.secret_key
  
  depends_on = [ yandex_resourcemanager_folder_iam_member.storage_editor ]
}
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ Terraform

–ü—Ä–æ—Å—Ç—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
‚≠êÔ∏è String ‚Äî –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏–º–≤–æ–ª–æ–≤ Unicode, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∞—è —Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, hello).
‚≠êÔ∏è Number ‚Äî —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å —Ü–µ–ª—ã–µ —á–∏—Å–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15) –∏ –¥—Ä–æ–±–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 6,283185).
‚≠êÔ∏è Bool ‚Äî –ª–æ–≥–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (true –ª–∏–±–æ false), –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —É—Å–ª–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–µ

–°–ª–æ–∂–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
üåü –ö–æ–ª–ª–µ–∫—Ü–∏–∏ ‚Äî –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Å—Ö–æ–∂–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π.
üåü –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —Ç–∏–ø—ã ‚Äî –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –Ω–µ—Å—Ö–æ–∂–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π.

–ö–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ–ª—è—Ç—Å—è –Ω–∞ —Ç—Ä–∏ –≥—Ä—É–ø–ø—ã:
1Ô∏è‚É£ –ö–æ–ª–ª–µ–∫—Ü–∏—è list(‚Ä¶)
2Ô∏è‚É£ –ö–æ–ª–ª–µ–∫—Ü–∏—è map(‚Ä¶)
3Ô∏è‚É£ –ö–æ–ª–ª–µ–∫—Ü–∏—è set(‚Ä¶)

–°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–µ–ª—è—Ç—Å—è –Ω–∞ –¥–≤–∞ –≤–∏–¥–∞:
1Ô∏è‚É£ –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö object(‚Ä¶)
2Ô∏è‚É£ –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö tuple(...)

!!! warning
        ‚ùóÔ∏è –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–º–µ–Ω–∞: source, version, providers, count, for_each, lifecycle, depends_on, locals.

!!! info
        –ê—Ä–≥—É–º–µ–Ω—Ç *sensitive* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –≤—ã–≤–æ–¥ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Terraform –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
      –ê—Ä–≥—É–º–µ–Ω—Ç *nullable* –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç, –º–æ–∂–µ—Ç –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –±—ã—Ç—å –ø—Ä–∏—Å–≤–æ–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ null.

```
variable "image_id" {
  type = string
}

variable "security_group_ids" {
  description = "(Optional) - List of security group IDs."
  type        = list(string)
  default     = []
}

variable "pg_version" {
  description = "PostgreSQL version"
  type        = string
  default     = "15"
  validation {
    condition     = contains(["12", "12-1c", "13", "13-1c", "14", "14-1c", "15", "15-1c", "16"], var.pg_version)
    error_message = "Allowed PostgreSQL versions are 12, 12-1c, 13, 13-1c, 14, 14-1c, 15, 15-1c, 16."
  }
}

variable "access_policy" {
  description = "Access policy from other services to the PostgreSQL cluster."
  type = object({
    data_lens     = optional(bool, null)
    web_sql       = optional(bool, null)
    serverless    = optional(bool, null)
    data_transfer = optional(bool, null)
  })
  default = {}
}

variable "example" {
  type     = string
  nullable = false
} 

variable "user_information" {
  type = object({
    name    = string
    address = string
  })
  sensitive = true
}

resource "some_resource" "a" {
  name    = var.user_information.name
  address = var.user_information.address
}
```

### –°–ø–æ—Å–æ–±—ã –∑–∞–¥–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

Terraform –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:
1Ô∏è‚É£ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
2Ô∏è‚É£ –§–∞–π–ª terraform.tfvars, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å.
3Ô∏è‚É£ –§–∞–π–ª terraform.tfvars.json, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å.
4Ô∏è‚É£ –õ—é–±—ã–µ —Ñ–∞–π–ª—ã *.auto.tfvars –∏–ª–∏*.auto.tfvars.json, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ –≤ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –∏—Ö –∏–º—ë–Ω.
5Ô∏è‚É£ –õ—é–±—ã–µ –æ–ø—Ü–∏–∏ -var –∏ -var-file –≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è.

–í –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ

```
terraform apply -var="image_id=fd8ne6e3etbrr2ve9nlc"
terraform apply -var='image_id_list=["fd8ne6e3etbrr2ve9nlc","fd8fsjddp35jvb4e4jo7"]' -var="cores=4"
terraform apply -var='subnet_map={"ru-central1-a":"subnet-a","ru-central1-b":"subnet-b"}'
```

–í —Ñ–∞–π–ª–µ

```
terraform apply -var-file="testing.tfvars"

image_id = "fd8ne6e3etbrr2ve9nlc"
zone_names = [
  "ru-central1-a",
  "ru-central1-b",
] 
```

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
Terraform –∏—â–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å TF_VAR_), –∑–∞ –∫–æ—Ç–æ—Ä—ã–º —Å–ª–µ–¥—É–µ—Ç –∏–º—è –æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π.

```
export TF_VAR_image_id=fd8ne6e3etbrr2ve9nlc
terraform plan
```

### –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

```terraform
locals {
  boot_disk_name      = "${var.name_prefix}-boot-disk"
  linux_vm_name       = "${var.name_prefix}-linux-vm"
 
  labels = {
      owner = "DevOps"
      env   = "dev"
  } 
}

resource "yandex_compute_disk" "boot_disk" {
  name = local.boot_disk_name

...

labels = local.labels
}

resource "yandex_compute_instance" "this" {
  name = local.linux_vm_name

...

  labels = local.labels
}

resource "yandex_vpc_subnet" "this" {
...

labels = local.labels
}
```

### –í—ã—Ö–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ/–∑–Ω–∞—á–µ–Ω–∏—è

```terraform
output "boot_disk_id" {
  description = "The ID of the boot disk created for the instance."
  value       = yandex_compute_disk.boot_disk.id
}

output "instance_id" {
  description = "The ID of the Yandex Compute instance."
  value       = yandex_compute_instance.this.id
}

output "subnet_id" {
  description = "The ID of the VPC subnet used by the Yandex Compute instance."
  value       = yandex_vpc_subnet.private.id
}

output "ydb_id" {
  description = "The ID of the Yandex Managed Service for YDB instance."
  value       = yandex_ydb_database_serverless.this.id
}

output "service_account_id" {
  description = "The ID of the Yandex IAM service account."
  value       = yandex_iam_service_account.bucket.id
}

output "bucket_name" {
  description = "The name of the Yandex Object Storage bucket."
  value       = yandex_storage_bucket.this.bucket
}

output "access_key" {
  description = "access key"
  sensitive   = true
  value       = yandex_iam_service_account_static_access_key.this
}
```

Sensitive –∑–Ω–∞—á–µ–Ω–∏—è

```terraform
‚ùØ terraform output access_key
```

## –§—É–Ω–∫—Ü–∏–∏

### –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ Terraform

–†–∞–±–æ—Ç–∞ —Å —á–∏—Å–ª–∞–º–∏ - min, max, pow, floor, ceil
–†–∞–±–æ—Ç–∞ —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏ - format, join, split, substr
–†–∞–±–æ—Ç–∞ —Å –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏ - length, lookup, flatten, element, map, merge
–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ - base64decode, base64encode, jsonencode
–û–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π - file, fileexists, abspath, templatefile
–†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º - formatdate, timestamp
–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ö–µ—à-—Ñ—É–Ω–∫—Ü–∏–∏ - base64sha512, bcrypt
–†–∞–±–æ—Ç—ã —Å —Å–µ—Ç–µ–≤–æ–π CIDR - cidrsubnet, cidrhost
–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ - tobool, tomap, tolist

```terraform
variable "value" {
  default = "hello"
}

output "transformed_value" {
  value = upper(format(‚Äútransformed: %s‚Äù, var.value))
}
```

```
terraform console

cidrnetmask("172.16.0.0/12")

```

## –£–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
